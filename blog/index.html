<!doctypehtml><meta charset=utf-8><meta content=width=device-width,initial-scale=1 name=viewport><title>purplesyringa's blog</title><link href=../all.css rel=stylesheet><link href=../blog.css rel=stylesheet><link href=../vendor/Temml-Local.css rel=stylesheet><link crossorigin href=https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,400;0,700;1,400;1,700&family=Slabo+27px&display=swap rel=stylesheet><link href=../fonts/webfont.css rel=stylesheet><link media="screen and (prefers-color-scheme: dark"href=../vendor/atom-one-dark.min.css rel=stylesheet><link media="screen and (prefers-color-scheme: light"href=../vendor/a11y-light.min.css rel=stylesheet><link title="Blog posts"href=/blog/feed.rss rel=alternate type=application/rss+xml><script data-website-id=0da1961d-43f2-45cc-a8e2-75679eefbb69 defer src=https://zond.tei.su/script.js></script><body><header><div class=viewport-container><div class=media><a href=https://github.com/purplesyringa><img alt=GitHub src=../images/github-mark-white.svg></a></div><h1><a href=/>purplesyringa</a></h1><nav><a href=..>about</a><a class=current href>blog</a><a href=../sink/>kitchen sink</a></nav></div></header><section><div class=viewport-container><p><a href=/blog/feed.rss><i class="nf nf-fa-rss_square"title=RSS></i> Subscribe to RSS</a><div class=post-entry><h2><a href=./division-is-hard-but-it-does-not-have-to-be/>Division is hard, but it doesn't have to be</a></h2><time>August 24, 2024</time><a class=discussion href=https://www.reddit.com/r/programming/comments/1f0n8sk/division_is_hard_but_it_doesnt_have_to_be/><i class="nf nf-md-comment"title=Comment></i> Discuss on Reddit</a><p>Developers don’t usually divide numbers all the time, but hashmaps often need to compute <a href=https://en.wikipedia.org/wiki/Remainder>remainders</a> modulo a prime. Hashmaps are really common, so fast division is useful.<p>For instance, rolling hashes might compute <code>u128 % u64</code> with a fixed divisor. Compilers just drop the ball here:<pre><code class=language-rust><span class=hljs-keyword>fn</span> <span class="hljs-title function_">modulo</span>(n: <span class=hljs-type>u128</span>) <span class=hljs-punctuation>-></span> <span class=hljs-type>u64</span> {
    (n % <span class=hljs-number>0xffffffffffffffc5</span>) <span class=hljs-keyword>as</span> <span class=hljs-type>u64</span>
}
</code></pre><pre><code class=language-x86asm><span class=hljs-symbol>modulo:</span>
    <span class=hljs-keyword>push</span>    <span class=hljs-built_in>rax</span>
    <span class=hljs-keyword>mov</span>     <span class=hljs-built_in>rdx</span>, -<span class=hljs-number>59</span>
    <span class=hljs-keyword>xor</span>     <span class=hljs-built_in>ecx</span>, <span class=hljs-built_in>ecx</span>
    <span class=hljs-keyword>call</span>    <span class=hljs-built_in>qword</span> <span class=hljs-built_in>ptr</span> [<span class=hljs-built_in>rip</span> + __umodti3@GOTPCREL]
    <span class=hljs-keyword>pop</span>     <span class=hljs-built_in>rcx</span>
    <span class=hljs-keyword>ret</span>
</code></pre><p><code>__umodti3</code> is a generic long division implementation, and it’s slow and ugly.<p>I prefer my code the opposite of slow and ugly.<p><a href=./division-is-hard-but-it-does-not-have-to-be/>Keep reading</a></div><div class=post-entry><h2><a href=./i-sped-up-serde-json-strings-by-20-percent/>I sped up serde_json strings by 20%</a></h2><time>August 20, 2024</time><a class=discussion href=https://www.reddit.com/r/rust/comments/1eyxspu/i_sped_up_serde_json_strings_by_20/><i class="nf nf-md-comment"title=Comment></i> Discuss on Reddit</a><p>I have recently done some performance work and realized that reading about my experience could be entertaining. Teaching to <em>think</em> is just as important as teaching to <em>code</em>, but this is seldom done; I think something I’ve done last month is a great opportunity to draw the curtain a bit.<p><code>serde</code> is <em>the</em> Rust framework for serialization and deserialization. Everyone uses it, and it’s the default among the ecosystem. <code>serde_json</code> is the official <code>serde</code> “mixin” for JSON, so when people need to parse stuff, that’s what they use instinctively. There are other libraries for JSON parsing, like <a href=https://lib.rs/crates/simd-json>simd-json</a>, but <code>serde_json</code> is overwhelmingly used: it has <a href=https://crates.io/crates/serde_json/reverse_dependencies>26916</a> dependents at the time of this post, compared to only <a href=https://crates.io/crates/simd-json/reverse_dependencies>66</a> for <code>simd-json</code>.<p>This makes <code>serde_json</code> a good target <s>(not in a Jia Tan way)</s> for optimization. Chances are, many of those 26916 users would profit from switching to <code>simd-json</code>, but as long as they aren’t doing that, smaller optimizations are better than nothing, and such improvements are reapt across the ecosystem.<p><a href=./i-sped-up-serde-json-strings-by-20-percent/>Keep reading</a></div><div class=post-entry><h2><a href=./the-sentinel-trick/>The sentinel trick</a></h2><time>August 13, 2024</time><a class=discussion href=https://t.me/alisa_rummages/148><i class="nf nf-md-comment"title=Comment></i> Discuss on Telegram</a><p>The sentinel trick underlies a data structure with the following requirements:<ul><li>Read element by index in <eq><math><mrow><mi>O</mi><mo form=prefix stretchy=false>(</mo><mn>1</mn><mo form=postfix stretchy=false>)</mo></mrow></math></eq>,<li>Write element by index in <eq><math><mrow><mi>O</mi><mo form=prefix stretchy=false>(</mo><mn>1</mn><mo form=postfix stretchy=false>)</mo></mrow></math></eq>,<li>Replace all elements with a given value in <eq><math><mrow><mi>O</mi><mo form=prefix stretchy=false>(</mo><mn>1</mn><mo form=postfix stretchy=false>)</mo></mrow></math></eq>.</ul><p>It is not a novel technique by any means, but it doesn’t seem on everyone’s lips, so some of you might find it interesting.<p><a href=./the-sentinel-trick/>Keep reading</a></div><div class=post-entry><h2><a href=./you-might-want-to-use-panics-for-error-handling/>You might want to use panics for error handling</a></h2><time>August 13, 2024</time><p>Rust’s approach to error handling comes at a cost. The <code>Result</code> type often doesn’t fit in CPU registers, and callers of fallible functions have to check whether the returned value is <code>Ok</code> or <code>Err</code>. That’s a stack spill, a comparison, a branch, and a lot of error handling code intertwined with the hot path that <em>just shouldn’t be here</em>, which inhibits inlining, the most important optimization of all.<p>Exceptions and panics make it easy to forget about the occasional error, but they don’t suffer from inefficiency. Throwing an exception unwinds the stack automatically, without any cooperation from the functions except the one that throws the exception and the one that catches it. Wouldn’t it be <em>neat</em> if a mechanism with the performance of <code>panic!</code> and the ergonomics of <code>Result</code> existed?<p><a href=./you-might-want-to-use-panics-for-error-handling/>Keep reading</a></div><div class=post-entry><h2><a href=ru/base64-has-a-fixed-point/>У base64 есть неподвижная точка</a></h2><time>August 3, 2024</time><a class=discussion href=https://t.me/alisa_rummages/146><i class="nf nf-md-comment"title=Comment></i> Discuss on Telegram</a><pre><code class=language-shell><span class="hljs-meta prompt_">$ </span><span class=language-bash>&LT/dev/urandom <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> \
     | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> \
     | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>head</span> -1</span>
Vm0wd2QyUXlVWGxWV0d4V1YwZDRWMVl3WkRSV01WbDNXa1JTVjAxV2JETlhhMUpUVmpBeFYySkVU
<span class="hljs-meta prompt_">
$ </span><span class=language-bash>&LT/dev/urandom <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> \
     | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>base64</span> \
     | <span class=hljs-built_in>base64</span> | <span class=hljs-built_in>head</span> -1</span>
Vm0wd2QyUXlVWGxWV0d4V1YwZDRWMVl3WkRSV01WbDNXa1JTVjAxV2JETlhhMUpUVmpBeFYySkVU
</code></pre><p><a href=ru/base64-has-a-fixed-point/>Keep reading</a></div><div class=post-entry><h2><a href=./i-thought-i-was-smart-enough-to-play-with-fire/>I thought I was smart enough to play with fire</a></h2><time>June 20, 2024</time><a class=discussion href=https://codeforces.com/blog/entry/130661><i class="nf nf-md-comment"title=Comment></i> Discuss on Codeforces</a><p><a href=https://codeforces.com/blog/entry/126390>blazingio</a> cuts corners by design. It keeps the constant factor small and uses long forgotten algorithms people used before processors supported SIMD and integer division. But another limitation made this task much harder.<p>Size.<p>Professional libraries start exceeding the <a href=https>Codeforces</a> limit of 64 KiB really fast. Code minification barely helps, and neither does resorting to ugly code. So I cut a corner I don’t typically cut.<p>Undefined Behavior.<p>These two words make a seasoned programmer shudder. But sidestepping UB increases code size so much the library can hardly be used on CF. So I took a gamble. I meticulously scanned every instance of UB I used intentionally and made sure the compiler had absolutely no reason to miscompile it. I wrote excessive tests and run them on CI on all architecture and OS combinations I could think of. I released the library without so much as a flaw. It worked like clockwork.<p>And then, 3 months later, I updated README, and all hell broke loose.<p><a href=./i-thought-i-was-smart-enough-to-play-with-fire/>Keep reading</a></div><div class=post-entry><h2><a href=./recovering-garbled-bitcoin-addresses/>Recovering garbled Bitcoin addresses</a></h2><time>April 23, 2024</time><a class=discussion href=https://t.me/alisa_rummages/111><i class="nf nf-md-comment"title=Comment></i> Discuss on Telegram</a><p><a href=https://zeronet.io/>ZeroNet</a> is a decentralized network that enables dynamic sites, such as blogs and forums, unlike popular content-addressed storage networks that came later. Sites aren’t addressed by immutable hashes; instead, site updates are signed by Bitcoin addresses.<p>A moot point is that Bitcoin addresses are case-sensitive, and people are used to addresses being case-insensitive. Mistakes happen, and sometimes the only trail you have is a lower-cased address, like <code>1lbcfr7sahtd9cgdqo3htmtkv8lk4znx71</code>.<p>Losing valuable information is a bad thing when you’re an archivist. Have we <em>really</em> lost access to the site if we only know the lower-cased address? Can we recover the original address somehow?<p><a href=./recovering-garbled-bitcoin-addresses/>Keep reading</a></div></div></section><footer><div class=viewport-container><h2>Made with my own bare hands (why.)</h2></div></footer>