<!doctypehtml><html prefix="og: http://ogp.me/ns#"lang=en_US><meta charset=utf-8><meta content=width=device-width,initial-scale=1 name=viewport><title>We built the best "Bad Apple!!" in Minecraft | purplesyringa's blog</title><link href=../../all.css rel=stylesheet><link href=../../blog.css rel=stylesheet><link href=../../vendor/Temml-Local.css rel=stylesheet><link crossorigin href=https://fonts.googleapis.com/css2?family=Noto+Sans:ital,wght@0,100..900;1,100..900&family=Roboto+Mono:ital,wght@0,100..700;1,100..700&family=Roboto:ital,wght@0,400;0,700;1,400;1,700&family=Slabo+27px&display=swap rel=stylesheet><link href=../../fonts/webfont.css rel=stylesheet><link media="screen and (prefers-color-scheme: dark"href=../../vendor/atom-one-dark.min.css rel=stylesheet><link media="screen and (prefers-color-scheme: light"href=../../vendor/a11y-light.min.css rel=stylesheet><link title="Blog posts"href=../../blog/feed.rss rel=alternate type=application/rss+xml><meta content='We built the best "Bad Apple!!" in Minecraft'property=og:title><meta content=article property=og:type><meta content=https://purplesyringa.moe/blog/we-built-the-best-bad-apple-in-minecraft/og.png property=og:image><meta content=https://purplesyringa.moe/blog/we-built-the-best-bad-apple-in-minecraft/ property=og:url><meta content="Demoscene is the art of pushing computers to perform tasks weren’t designed to handle. One recurring theme in demoscene is the shadow-art animation “Bad Apple!!”. We’ve played it on the Commodore 64, Vectrex (a unique game console utilizing only vector graphics), Impulse Tracker, and even exploited Super Mario Bros. to play it.
But how about Bad Apple!!.. in Minecraft?"property=og:description><meta content=en_US property=og:locale><meta content="purplesyringa's blog"property=og:site_name><meta content=summary_large_image name=twitter:card><meta content=https://purplesyringa.moe/blog/we-built-the-best-bad-apple-in-minecraft/og.png name=twitter:image><script data-website-id=0da1961d-43f2-45cc-a8e2-75679eefbb69 defer src=https://zond.tei.su/script.js></script><body><header><div class=viewport-container><div class=media><a href=https://github.com/purplesyringa><img alt=GitHub src=../../images/github-mark-white.svg></a></div><h1><a href=/>purplesyringa</a></h1><nav><a href=../..>about</a><a class=current href=../../blog/>blog</a><a href=../../sink/>kitchen sink</a></nav></div></header><section><div class=viewport-container><h2>We built the best "Bad Apple!!" in Minecraft</h2><time>October 10, 2024</time><a class=discussion href=https://news.ycombinator.com/item?id=41798369><i class="nf nf-md-comment"title=Comment></i> Hacker News</a><p>Demoscene is the art of pushing computers to perform tasks weren’t designed to handle. One recurring theme in demoscene is the shadow-art animation “Bad Apple!!”. We’ve played it on the Commodore 64, <a href=https://en.wikipedia.org/wiki/Vectrex>Vectrex</a> (a unique game console utilizing only vector graphics), <a href=https://www.youtube.com/watch?v=SDvk3aL78fI>Impulse Tracker</a>, and even <a href=https://tasvideos.org/6012M>exploited Super Mario Bros.</a> to play it.<p>But how about Bad Apple!!.. in Minecraft?<p class=next-group><span aria-level=3 class=side-header role=heading><span>Video</span></span>Link: <a href=https://www.youtube.com/watch?v=UDIRAfurpOI>YouTube</a>.<p><div class=diagram><iframe allow="clipboard-write; picture-in-picture; web-share"title="Bad Apple!!"allowfullscreen frameborder=0 referrerpolicy=strict-origin-when-cross-origin src=https://www.youtube.com/embed/UDIRAfurpOI style=aspect-ratio:16/9></iframe></div><p class=next-group><span aria-level=3 class=side-header role=heading><span>Credits</span></span>This project required a great deal of ingenuity. In this post, I’ll detail how it came together, but first, I want to thank some incredible people who made it possible:<ul><li><a href=https://github.com/yuki0iq>Yuki</a>, for inventing several core techniques, gathering raw data and preprocessing it with ffmpeg (I hate ffmpeg).<li><a href=https://github.com/miabaka>Mia</a>, for testing performance on a high-end PC and getting me up-to-speed on dithering techniques.<li><a href=https://github.com/q60>kira</a>, for testing performance, recording the video, and rubber duck debugging.</ul><p class=next-group><span aria-level=3 class=side-header role=heading><span>Try it out</span></span><a href=https://mega.nz/file/dZhzmKCL#X0abTQv3NPU-EbQfEwaTs1i4IpBZKW3TufRc9wfbhsM>Download world</a>.<p>On low-end devices, you might have to install <a href=https://modrinth.com/mod/vulkanmod>VulkanMod</a> (preferably) or <a href=https://modrinth.com/mod/sodium>Sodium</a> (if Vulkan is unavailable) for satisfactory performance. <strong>Avoid</strong> <a href=https://modrinth.com/mod/c2me-fabric>C2ME</a>, as its autosaving facilities lead to performance regressions.<h2>The story</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Prologue</span></span>I’m not the first to attempt this, but I believe I came closer to perfection than anyone before me:<ul><li>The video plays at 20 fps, the highest frame rate possible in Minecraft.<li>The image resolution is <eq><math><mrow><mn>512</mn><mo>×</mo></mrow><mrow><mn>384</mn></mrow></math></eq>, just like the original animation.<li>It’s grayscale, not just black-and-white.<li>On modern CPUs and GPUs, you can join a world and see the demo play at 20 fps exactly. I didn’t speed up the video after recording. This is really hard to achieve, as Minecraft’s engine is pretty slow.<li>It uses no command blocks.</ul><h2>Setting the scene</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Rules</span></span>I do things not because they are easy, but because they are hard. Before diving in, let’s rule out some incredibly easy, almost cheaty ways to run Bad Apple!! in Minecraft:<ol><li>Using mods is not okay. Sodium and other optimization mods can be used for testing on low-end devices, but the video must play in real-time on high-end devies on vanilla.<li>Using command blocks to achieve 20 fps or use <code>/setblock</code> is not okay.<li>Using datapacks, which are basically another way to use commands, is not okay.<li>Using animated textures is not okay.</ol><p class=next-group><span aria-level=3 class=side-header role=heading><span>Prior art</span></span>I didn’t want to go into this blind, so I tried to find what others did before me. Thanks for motivating me to do my best!<div class=table-wrapper><table><thead><tr><th>Author + video link<th>Frames<th>Resolution<th>Colors<th>Slower than real-time?<th>Method<tbody><tr><td>My goal<td>20 fps<td><eq><math><mrow><mn>512</mn><mo>×</mo></mrow><mrow><mn>384</mn></mrow></math></eq><td><eq><math><mrow><mo>></mo></mrow><mrow><mn>2</mn></mrow></math></eq><td>Real-time<td>???<tr><td><a href=https://www.youtube.com/watch?v=9jW6WyRoDAQ>Sloimay</a><td>30 fps<td><eq><math><mrow><mn>96</mn><mo>×</mo></mrow><mrow><mn>72</mn></mrow></math></eq><td>B/W<td><eq><math><mrow><mn>6</mn><mo>×</mo></mrow></math></eq> (simulation only)<td>Command blocks<tr><td><a href=https://www.youtube.com/watch?v=JUJUwZbl304>Sloimay</a><td>15 fps<td><eq><math><mrow><mn>64</mn><mo>×</mo></mrow><mrow><mn>48</mn></mrow></math></eq><td>B/W<td><eq><math><mrow><mn>300</mn><mo>×</mo></mrow></math></eq><td>Pure redstone<tr><td><a href=https://www.youtube.com/watch?v=AY5ROo13oIM>Mod Punchtree</a><td>2 fps<td><eq><math><mrow><mn>32</mn><mo>×</mo></mrow><mrow><mn>24</mn></mrow></math></eq><td>B/W<td><eq><math><mrow><mo>≥</mo></mrow><mrow><mn>10</mn><mo>×</mo></mrow></math></eq>, hard to estimate<td>Pure redstone (MPU 8)<tr><td><a href=https://www.youtube.com/watch?v=LCipkEvrBRg>Mod Punchtree</a><td>12 fps<td><eq><math><mrow><mn>64</mn><mo>×</mo></mrow><mrow><mn>48</mn></mrow></math></eq><td>B/W<td><eq><math><mrow><mn>250</mn><mo>×</mo></mrow></math></eq><td>Pure redstone (IRIS)<tr><td><a href=https://www.youtube.com/watch?v=BakQ6GrHvqs>Green_Jab</a><td>5 fps<td><eq><math><mrow><mn>40</mn><mo>×</mo></mrow><mrow><mn>30</mn></mrow></math></eq><td>B/W<td>Real-time!<td>Pure redstone<tr><td><a href=https://www.youtube.com/watch?v=4tPdhZFirMU>SleeperPin</a><td>5 fps<td><eq><math><mrow><mn>15</mn><mo>×</mo></mrow><mrow><mn>12</mn></mrow></math></eq><td>B/W<td>Real-time!<td>Pure redstone (23w45a only)<tr><td><a href=https://www.youtube.com/watch?v=4ZYzYNzxhKE>NuclearShadow</a><td>4 fps<td>Small<td>B/W<td>Real-time, probably<td>Command blocks (+ particles)<tr><td><a href=https://www.reddit.com/r/Minecraft/comments/1dq1tcd/bad_apple_full_res/>catlord5</a><td>30 fps<td><eq><math><mrow><mn>512</mn><mo>×</mo></mrow><mrow><mn>384</mn></mrow></math></eq><td><eq><math><mrow><mo>≥</mo></mrow><mrow><mn>10</mn></mrow></math></eq><td><eq><math><mrow><mo>≈</mo></mrow><mrow><mn>40</mn><mo>×</mo></mrow></math></eq><td>Datapacks<tr><td><a href=https://www.reddit.com/r/Minecraft/comments/1dq1tcd/bad_apple_full_res/>Naratna</a><td>20 fps<td><eq><math><mrow><mn>56</mn><mo>×</mo></mrow><mrow><mn>42</mn></mrow></math></eq><td><eq><math><mn>8</mn></math></eq><td>Real-time!<td>Datapacks + structures<tr><td><a href=https://www.reddit.com/r/Minecraft/comments/siyi4c/i_made_bad_apple_using_only_redstone_this_is_the/>I_Really_Like_Stairs</a><td>10 fps<td><eq><math><mrow><mn>20</mn><mo>×</mo></mrow><mrow><mn>15</mn></mrow></math></eq><td>B/W<td><eq><math><mrow><mo>≈</mo></mrow><mrow><mn>20</mn><mo>×</mo></mrow></math></eq><td>First 150 frames only<tr><td><a href=https://www.youtube.com/watch?v=RN3QW9SVnds>Klinbee</a><td><td><td><td><td>Honorary mention</table></div><p class=next-group><span aria-level=3 class=side-header role=heading><span>Back of the napkin</span></span>Most of these attempts used really small screens, compared to the original animation. The video by catlord5 was an exception, but it rendered <eq><math><mrow><mn>40</mn><mo>×</mo></mrow></math></eq> slower than I’d liked it to. This was hardly a surprise: Minecraft has a very slow game engine (for the dumbest reasons), so I’d need lots of clever optimizations.<p>Minecraft’s simulation engine is notoriously slow, but its rendering engine isn’t much better. While Sodium optimizes the latter, I wanted to achieve real-time performance on vanilla too. Rendering a <eq><math><mrow><mn>16</mn><mo>×</mo></mrow><mrow><mn>16</mn><mo>×</mo></mrow><mrow><mn>16</mn></mrow></math></eq> chunk is slow independent of its contents, so the fewer chunks the screen spans, the better.<p>20 fps is hard to achieve for another reason. Redstone can’t run faster than 20 ticks per second, so any practically usable clock generators emit 10 Hz signals, which is not enough to get 20 fps. In fact, it’s even worse: redstone dust is, like, the only component that doesn’t introduce tick delays, but <a href=https://empireminecraft.com/threads/a-guide-to-lag-busting-%E2%80%93-the-things-you-can-do.84889/>it’s very laggy</a>, because no one at Mojang seems to know graph algorithms.<p>Oh boy, I’m not going to finish this over a weekend.<h2>How it started</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Data source</span></span>Ironically, the most challenging part of this project was figuring out how to store raw frames in Minecraft.<p>There’s really few popular ways to store data.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Hopper line</span></span>The most popular one is to store items in chests and take them out with hoppers:<p><div class=diagram><img alt="A double chest, connected via a hopper to another double chest, connected via another hopper to the 3rd double chest, connected to the 4th double chest. One of the hoppers is analyzed by a comparator."title="A double chest, connected via a hopper to another double chest, connected via another hopper to the 3rd double chest, connected to the 4th double chest. One of the hoppers is analyzed by a comparator."src=hopper-line.png></div><p>Hoppers take the items out in the same order they are put in. Comparators emit the fullness of the containers they are connected to as a power level. Some items can be disambiguated by their fullness (e.g. a cake weighs <eq><math><mrow><mn>64</mn><mo>×</mo></mrow></math></eq> more than dirt), so this effectively stores a sequence of bits.<p>The problem is that hoppers have a delay of 0.4s between transferring items, reducing the maximum possible frame rate to 2.5 fps. To achieve 5 fps (or 10 fps with <a href=https://en.wikipedia.org/wiki/Interlaced_video>interlaced video</a>), two hoppers need to be run concurrently, which is difficult to tile. Honest 10 fps require 4 hoppers, and hoppers are damn slow to simulate. And I wanted 20 fps.<p>This wasn’t going to work.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Packed binary</span></span>If I couldn’t decrease latency, what about increasing throughput?<p>Minecraft has music discs, which, when put into jukeboxes and read out via comparators, emit a number from 1 to 15, depending on the disc. That’s almost 4 bits; with luck, I’ll figure out how to pad it to 4 bits exactly, and then I’ll spread these 4 bits over time, increasing the frame rate from 2.5 fps to 10 fps (if 1 hopper is used) or to 20 fps (if 2 hoppers are used).<p>Shifting bits, however, requires quite a bit of logic, and redstone dust is slow. I made a prototype and, lo and behold, it was in fact slow, as predicted. (I’m smart.)<p>I needed something simpler.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Repeater line</span></span>Let’s dumb it down by borrowing I_Really_Like_Stairs’s idea. It’s the most stupid way of storing data I could think of: just a line of repeaters acting as a delay line, pre-configured to emit the right values at the right moments:<p><div class=diagram><img alt="Two 1x1 repeater lines on top of each other. A repeater line is a line of blocks alternating between sandstone and repeaters. Lines are offset by one block, so that the repeaters of the top line stand on sandstone of the bottom line. The lines end with iron trapdoors."title="Two 1x1 repeater lines on top of each other. A repeater line is a line of blocks alternating between sandstone and repeaters. Lines are offset by one block, so that the repeaters of the top line stand on sandstone of the bottom line. The lines end with iron trapdoors."src=redstone-line.png></div><p>This enables tileable 1x1 pixels. Unfortunately, it seems to be <em>really</em> slow: I_Really_Like_Stairs’s video had <eq><math><mrow><mn>650</mn><mo>×</mo></mrow></math></eq> smaller resolution than my target, contained only the first 150 frames, and had to be sped up <eq><math><mrow><mn>20</mn><mo>×</mo></mrow></math></eq> anyway. So even this very simple solution was not going to cut it.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Structures</span></span>Okay, I give up. Is there something that isn’t quite redstone, but is still considered more or less vanilla?<p>Hmm, there’s something called <a href=https://minecraft.wiki/w/Structure_Block>structure blocks</a>. They aren’t obtainable in survival, but they aren’t nearly as overpowered as command blocks. They act like Ctrl-C/Ctrl-V of sorts: a structure block put into <code>SAVE</code> mode can store a region of blocks to memory to a named location, and a <code>LOAD</code> structure block can load it to another place. Structure blocks can be activated by redstone, so it’s as simple as connecting a structure block to a clock, right?<p class=next-group><span aria-level=3 class=side-header role=heading><span>Disclaimer</span></span>You might think this is cheating. It’s not “real” redstone, so it doesn’t count. But I think that’s an ignorant point of view.<p>We like redstone because it lets us build complicated mechanisms, like computers, from simple and limited components. We dislike commands because they reduce large redstone builds to just one command, almost laughing at redstone builders.<p>In my opinion, <strong>structstone</strong> is much closer to redstone than commands. Whatever we’re going to achieve is not going to be easy in the slightest. It’s not as simple as “put blocks at the right places”. In fact, we haven’t even started. There’s going to be <em>a lot</em> of reverse-engineering, techniques borrowed from video codecs, and other clever solutions down below. Some of the problems pushed me to the limit, and perfecting the solutions required collaboration with other people.<p>If this is your hard boundary, I’m sorry. If it isn’t, keep reading – I promise I won’t disappoint you.<h2>How it’s going</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Animation</span></span>Structure blocks are easy to use. You place the blocks you wish to save and a structure block nearby, configuring it to <code>SAVE</code> the region to a named location. You then activate the block. To load the region, you place another structure block, configure it to <code>LOAD</code>, and activate it with a redstone signal (a button in the screenshot below):<p><div class=diagram><img alt='Three structure blocks in a row. The first one is configured to save the block above it (red wool) to a location called "red". The next one saved a yellow wool block to "yellow". The third one is configured to load a block from "red" above it. There&#39s no block there yet, but a redstone line with a button is connected to the structure block; when pressed, the button would trigger the loading.'title='Three structure blocks in a row. The first one is configured to save the block above it (red wool) to a location called "red". The next one saved a yellow wool block to "yellow". The third one is configured to load a block from "red" above it. There&#39s no block there yet, but a redstone line with a button is connected to the structure block; when pressed, the button would trigger the loading.'src=structure-blocks.png></div><p>But how do you <em>animate</em> anything? Loading the same structure repeatedly is not going to cut it.<p>Guess what? The area a <code>LOAD</code> structure block affects can overlap with the structure block itself. So, a structure block can replace itself with another structure block configured to load a different structure!<p><div class=diagram><img alt='A structure block saves two blocks above it to "red". The blocks are, from bottom to top: 1) a structure block loading from "yellow", overlapping with itself, 2) a red wool block. There&#39s another such construction with "red" and "yellow" swapped nearby. The third structure block loads from "red" with a button, but isn&#39t activated yet.'title='A structure block saves two blocks above it to "red". The blocks are, from bottom to top: 1) a structure block loading from "yellow", overlapping with itself, 2) a red wool block. There&#39s another such construction with "red" and "yellow" swapped nearby. The third structure block loads from "red" with a button, but isn&#39t activated yet.'src=structure-blocks-red-yellow.png></div><p>In theory, when the “<code>LOAD</code> from red” block is activated, it should load a red wool block but also replace itself with a “<code>LOAD</code> from yellow” block, so the colors should alternate between activations.<p>In practice, there’s a <em>big</em> lag spike, a <em>yellow</em> wool block is spawned instead of a red one, and the redstone dust stays powered despite the button being unpressed:<p><div class=diagram><img alt="A yellow wool block appears above the third structure block. The button is unpressed, but the dust is active."title="A yellow wool block appears above the third structure block. The button is unpressed, but the dust is active."src=structure-blocks-red-yellow-activated.png></div><p>Can you guess the reason?<p>When the “<code>LOAD</code> from red” block is activated, it places a red wool block and a new structure block. It then sends updates to these blocks. The new structure block receives an update, detects the nearby activated redstone dust, and activates immediately. This loads a yellow wool block and another structure block. It then sends updates to these blocks. The new structure block receives an update…<p>This recursion ends when Minecraft hits a hard limit, which by luck results in a yellow block being spawned instead of a red one. The limit runs out before Minecraft fully processes the redstone dust depowering, so the power levels along the line only partially update, turning from <eq><math><mrow><mn>15</mn><mo separator=true>,</mo></mrow><mrow><mn>14</mn><mo separator=true>,</mo></mrow><mrow><mn>13</mn><mo separator=true>,</mo></mrow><mrow><mn>12</mn><mo separator=true>,</mo></mrow><mrow><mn>11</mn></mrow></math></eq> to <eq><math><mrow><mn>7</mn><mo separator=true>,</mo></mrow><mrow><mn>8</mn><mo separator=true>,</mo></mrow><mrow><mn>9</mn><mo separator=true>,</mo></mrow><mrow><mn>10</mn><mo separator=true>,</mo></mrow><mrow><mn>9</mn></mrow></math></eq> instead of <eq><math><mrow><mn>0</mn><mo separator=true>,</mo></mrow><mrow><mn>0</mn><mo separator=true>,</mo></mrow><mrow><mn>0</mn><mo separator=true>,</mo></mrow><mrow><mn>0</mn><mo separator=true>,</mo></mrow><mrow><mn>0</mn></mrow></math></eq> as expected.<p>Theoretically, <a href=https://minecraft.wiki/w/Tutorials/Zero-ticking>zero-ticking</a> should prevent this, but I’ve had enough of theory. Let’s just add a delay with a repeater:<p><div class=diagram><img alt='"red" and "yellow" structures, each 3 blocks wide and 2 block tall. The bottom right corners of both structures contain structure blocks loading the other structure over itself. The "red" structure has a red wool block above the structure block, the "yellow" one has a yellow wool block at the same location. Both structure blocks are powered by a redstone block (in bottom left) with a repeater inbetween. Both repeaters are OFF.'title='"red" and "yellow" structures, each 3 blocks wide and 2 block tall. The bottom right corners of both structures contain structure blocks loading the other structure over itself. The "red" structure has a red wool block above the structure block, the "yellow" one has a yellow wool block at the same location. Both structure blocks are powered by a redstone block (in bottom left) with a repeater inbetween. Both repeaters are OFF.'src=working-structure-blocks-red-yellow.png></div><p>These structures should be built under <code>/tick freeze</code>, so that the repeaters are turned off. This way, when the structure is loaded, there’s a 1 redstone tick delay before replacing the structure:<p><div class=diagram><strong class=epilepsy> This video contains flashes that might trigger seizures in people with photosensitive epilepsy. Stop watching if you experience any symptoms. For convenience, the title text for the video explains the action in prose. </strong><video alt="The structure from above alternating between red and yellow wool every redstone tick."title="The structure from above alternating between red and yellow wool every redstone tick."controls loop muted playsinline preload=auto src=working-structure-blocks-red-yellow-running.webm#epilepsy></video></div><p class=next-group><span aria-level=3 class=side-header role=heading><span>Activation</span></span>This mechanism can be paused by locking the repeater:<p><div class=diagram><img alt="Another repeater points into the repeater in the structure. Before this new repeater is an enabled lever. The repeater in the structure is locked."title="Another repeater points into the repeater in the structure. Before this new repeater is an enabled lever. The repeater in the structure is locked."src=working-structure-blocks-red-yellow-locked.png></div><p>A simpler mechanism can control starting (without pausing) with a single button:<p><div class=diagram><img alt="The 3x2 structure from earlier is shown, with the redstone block and the repeater omitted. A solid block (stone) is placed in the repeater's stead, neighboring the structure block. The solid block is connected via a redstone wire to a button, both located outside the structure."title="The 3x2 structure from earlier is shown, with the redstone block and the repeater omitted. A solid block (stone) is placed in the repeater's stead, neighboring the structure block. The solid block is connected via a redstone wire to a button, both located outside the structure."src=red-yellow-non-started.png></div><p>When the button is pressed, the solid block gets weakly powered and immediately activates the structure block. The structure immediately replaces the solid block with a repeater, which ignores the dust, so no infinite recursion happens. After the last frame, the structure block can place the solid block back to allow restarting.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Ticks</span></span>There are two kinds of ticks in Minecraft: redstone ticks and game ticks. The game engine recomputes physics at 20 Hz (game ticks), but redstone logic is only recomputed at 10 Hz (redstone ticks). At least, that’s the common explanation.<p>In reality, all events are processed at <eq><math><mn>0.05</mn></math></eq> s intervals; it’s just that redstone components schedule their updates in multiples of <eq><math><mn>0.1</mn></math></eq> s. So, if an event initiated by the user happens at <eq><math><mn>13.20</mn></math></eq> s, redstone may respond at <eq><math><mn>13.20</mn></math></eq> s, <eq><math><mn>13.30</mn></math></eq> s, <eq><math><mn>13.40</mn></math></eq> s, etc. And if the event occurs <eq><math><mn>0.05</mn></math></eq> s later, redstone will respond <eq><math><mn>0.05</mn></math></eq> s later too.<p>So far, we’ve seen colors alternating 10 times per second. For 20 fps, we need 4 structures:<p><div class=diagram><img alt="4 structures, now 2 block deep. The red and yellow structures are just like before, with the far layer being empty. The new blue and green structures have the redstone blocks, repeaters and structure blocks in the far layer, with the near layer being empty except for the wool block."title="4 structures, now 2 block deep. The red and yellow structures are just like before, with the far layer being empty. The new blue and green structures have the redstone blocks, repeaters and structure blocks in the far layer, with the near layer being empty except for the wool block."src=4-colors-components.png></div><p><div class=diagram><img alt="The same structures from above."title="The same structures from above."src=4-colors-components-up.png></div><p>The small pink cubes indicate <em>structure voids</em>: blocks that aren’t replaced when the structure is loaded. By default, even air can replace blocks, so these voids let us overlap structures.<p>The red and yellow structures form one 10 Hz clock, while the blue and green structures form another 10 Hz clock. Both clocks place the wool at the same position, so if the structures are activated at the right offset, four colors alternate at 20 Hz:<p><div class=diagram><strong class=epilepsy> This video contains flashes that might trigger seizures in people with photosensitive epilepsy. Stop watching if you experience any symptoms. For convenience, the title text for the video explains the action in prose. </strong><video alt="The two structures overlapped, visibly alternating between green, yellow, blue, and red."title="The two structures overlapped, visibly alternating between green, yellow, blue, and red."controls loop muted playsinline preload=auto src=4-colors.webm#epilepsy></video></div><p>This video was recorded by manually activating the two clocks at different times so that they run in different phases. To streamline this process, we can use a long-standing bug where pistons pushing redstone blocks take 3 game ticks to extend when activated directly by user input. This way, pressing a single button activates the mechanism with 100% success:<p><div class=diagram><img alt="The two structures overlapped using the starting mechanism from before. The redstone blocks are removed, the repeaters are replaced with solid blocks (targets). One target is powered from a button via redstone dust, while another target is powered by a redstone block pushed by a sticky piston, connected to the same button."title="The two structures overlapped using the starting mechanism from before. The redstone blocks are removed, the repeaters are replaced with solid blocks (targets). One target is powered from a button via redstone dust, while another target is powered by a redstone block pushed by a sticky piston, connected to the same button."src=4-colors-deactivated.png></div><p class=next-group><span aria-level=3 class=side-header role=heading><span>The End?</span></span>To make a screen, all we have to do is place a large grid of wool instead of just one block.<p><div class=diagram><strong class=epilepsy> This video contains flashes that might trigger seizures in people with photosensitive epilepsy. Stop watching if you experience any symptoms. For convenience, the title text for the video explains the action in prose. </strong><video alt="Five 48-block-tall towers: four for the original components, updating at 10 Hz, and the fifth one combined, updating at 20 Hz."title="Five 48-block-tall towers: four for the original components, updating at 10 Hz, and the fifth one combined, updating at 20 Hz."controls loop muted playsinline preload=auto src=towers.webm#epilepsy></video></div><p>Oof, that was tiresome, and that was just 48 block tall towers. I need… 384 blocks vertically? Wait, how tall are Minecraft worlds, anyway? That’s 384 blocks, i.e. 24 chunks. And it’s going to be 32 chunks horizontally. The maximum render distance is 32 chunks, so I’ll probably have to play around with FOV…<p>Wait, <em>how many chunks</em>? There’s a reason 32 chunks is the limit in vanilla: few devices can handle that. And unlike survival worlds, all those <eq><math><mrow><mn>32</mn><mo>×</mo></mrow><mrow><mn>24</mn><mo>=</mo></mrow><mrow><mn>768</mn></mrow></math></eq> chunks will constantly be updated at 20 Hz! That’s just not going to work.<p>Back to the drawing board?<h2>Or the beginning?</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Goal</span></span>Minecraft renders blocks in <eq><math><mrow><mn>16</mn><mo>×</mo></mrow><mrow><mn>16</mn><mo>×</mo></mrow><mrow><mn>16</mn></mrow></math></eq> chunks. Whenever any block in the chunk changes, the whole chunk is rerendered. This takes a while because Mojang supports a lot of legacy code. To address this, we need to decrease the number of chunks without sacrificing resolution.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Textures</span></span>That’s as impossible as placing blocks automatically. In other words, it’s possible if we introduce new tools.<p>Minecraft supports custom textures through resource packs (not to be confused with datapacks). We can replace the textures of several – say 16 – distinct blocks. 16 variants translate to 4 bits, which correspond to “subpixels” of a block:<p><div class=diagram><img alt="16 blocks of wool of different colors, using default Minecraft textures."title="16 blocks of wool of different colors, using default Minecraft textures."src=wool-untextured.png></div><p><div class=diagram><img alt='The same blocks of wool, with textures replaced by 2x2 black-and-white pictures with different pattern for each "color".'title='The same blocks of wool, with textures replaced by 2x2 black-and-white pictures with different pattern for each "color".'src=wool-textured.png></div><p>We can go futher. By taking <eq><math><mrow><msup><mn>4</mn><mn>4</mn></msup><mo>=</mo></mrow><mrow><mn>256</mn></mrow></math></eq> blocks and adding two more colors to the subpixels, we can shift from black-and-white to grayscale.<p>We’ve just reduced the block resolution <eq><math><mrow><mn>4</mn><mo>×</mo></mrow></math></eq>, to <eq><math><mrow><mn>256</mn><mo>×</mo></mrow><mrow><mn>192</mn></mrow></math></eq>, losslessly. That gets us down to 192 chunks updated at 20 Hz.<p>This is still a large number of chunks, but it’s manageable. The worst that can happen if there are too many updates is a decreased frame rate, right?<h2>There are nuances</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Background</span></span>You see, Minecraft’s rendering engine is tuned for the players, not whatever this is, so it prioritizes updates in nearby chunks.<p>Several threads build chunks concurrently. Whenever a chunk is updated, it’s added to a queue, and threads fetch the closest chunk to the player from the queue to rebuild.<p>If there are <eq><math><mi>N</mi></math></eq> threads and the <eq><math><mi>N</mi></math></eq> chunks closest to the player are updated so frequently that the workers barely finish processing them fully before they are updated again (20 times per second), <em>nothing</em> but those <eq><math><mi>N</mi></math></eq> chunks will ever be rendered.<p>You can partially observe this effect here:<p><div class=diagram><strong class=epilepsy> This video contains flashes that might trigger seizures in people with photosensitive epilepsy. Stop watching if you experience any symptoms. For convenience, the title text for the video explains the action in prose. </strong><video alt="Five towers from before, recorded while standing at the bottom. The red-yellow tower glitches occasionally, rendering as partially red and and partially yellow at times."title="Five towers from before, recorded while standing at the bottom. The red-yellow tower glitches occasionally, rendering as partially red and and partially yellow at times."controls loop muted playsinline preload=auto src=towers-glitch.webm#epilepsy></video></div><p>The towers clearly glitch in the middle occasionally because they span three chunks, so sometimes only two chunks are rendered in time.<p>We got lucky here: the render threads eventually catch up with the updates. However, in the actual demo, I needed to ensure that there was enough free time each tick for the render threads to catch up with older updates.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Optimization</span></span>According to <a href=https://spark.lucko.me/>Spark</a>, the bottleneck in my demo was just updates in general. It wasn’t even redstone or light updates, it was just <code>setBlock</code> and event handlers. The only way forward was to reduce the number of updates.<p>The simplest way to do that is delta coding. The concept is straightforward: since most frames change very little, only the blocks that differ between frames should be updated. In theory, this should improve performance in most scenes.<p>This sounded like a solid plan, so I began prototyping.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Prototype</span></span>A structure block can only load <eq><math><mrow><mn>48</mn><mo>×</mo></mrow><mrow><mn>48</mn><mo>×</mo></mrow><mrow><mn>48</mn></mrow></math></eq> blocks at once, so I had to tile <eq><math><mrow><mn>6</mn><mo>×</mo></mrow><mrow><mn>4</mn></mrow></math></eq> smaller <eq><math><mrow><mn>48</mn><mo>×</mo></mrow><mrow><mn>48</mn></mrow></math></eq> screens.<p>Instead of preparing the data by hand, I generated <a href=https://minecraft.wiki/w/Structure_file>structure files</a> with a script. I extracted frames from a video with <code>ffmpeg</code>, loaded them into Python with <code>Pillow</code>, and generated <a href=https://minecraft.wiki/w/NBT_format>NBT</a> files with <a href=https://pypi.org/project/nbtlib/>nbtlib</a>.<p>Unfortunately, I don’t have any screenshots from this period. The code ran slowly (about 7 minutes per run), the result was hard to launch (<code>/tick freeze</code>, press 24 buttons, <code>/tick unfreeze</code>), but it worked.<p>One problem: it was still too slow, even with delta coding. I knew my PC was old, but I doubted throwing more hardware at it would solve the issue sufficiently.<p class=next-group><span aria-level=3 class=side-header role=heading><span>Brainstorming</span></span>Increasing subpixel density in a block was not feasible: a <eq><math><mrow><mn>3</mn><mo>×</mo></mrow><mrow><mn>3</mn></mrow></math></eq> resolution would require <eq><math><mrow><msup><mn>4</mn><mn>9</mn></msup><mo>=</mo></mrow><mrow><mn>262144</mn></mrow></math></eq> blocks, far more than Minecraft has. Reducing color resolution to black-and-white was an option, but it wouldn’t be ideal. What did I have left?<p>That’s when I found an intriguing note on <a href=https://minecraft.wiki/w/Model>the wiki page for models</a>. Models specify block shapes: while most blocks are just cubes, some aren’t, like composters or stairs. Shapes are composed of cuboids specified by XYZ coordinates of two corners, with <code>(0, 0, 0)</code> for the front bottom left corner and <code>(16, 16, 16)</code> for the back top right corner. But the coordinates of the cuboids can range from <eq><math><mrow><mo>−</mo></mrow><mrow><mn>16</mn></mrow></math></eq> to <eq><math><mn>32</mn></math></eq>, 3 times wider than the block itself.<p>So with the right configuration, a block could render as if it was up to <eq><math><mrow><mn>3</mn><mo>×</mo></mrow></math></eq> larger than it should be, replacing 9 blocks. This is only applicable in some common cases, like a totally black or a totally white <eq><math><mrow><mn>6</mn><mo>×</mo></mrow><mrow><mn>6</mn></mrow></math></eq> pixel square, because there weren’t nearly enough blocks for all possible combinations. According to my calculations, there were about <eq><math><mn>600</mn></math></eq> usable blocks in Minecraft, so I had <eq><math><mrow><mn>600</mn><mo>−</mo></mrow><mrow><mn>256</mn><mo>=</mo></mrow><mrow><mn>344</mn></mrow></math></eq> blocks for this optimization. Or a bit fewer than that, because some of the blocks would be used for decoration.<p>After experimenting with some heuristics and block sizes, I settled on the following approach:<blockquote><p>The screen is divided into a <eq><math><mrow><mn>2</mn><mo>×</mo></mrow><mrow><mn>2</mn></mrow></math></eq> block grid, with each cell containing 4 blocks (16 pixels). Each possible <eq><math><mrow><mn>4</mn><mo>×</mo></mrow><mrow><mn>4</mn></mrow></math></eq> pixel sprite is a candidate for optimization into a single block. Throughout the algorithm, ranks of various sprites are computed. At the end, as many sprites as possible are assigned blocks, with higher ranks prioritized.<p>The ranks start at <eq><math><mn>0</mn></math></eq>. For every two consecutive frames, the difference between them is calculated, and cells that changed between frames have their ranks incremented (both old and new versions). The increment is proportional to the number of changed pixels between frames, so a cell changing in a fast scene weighs more than in a slow scene.</blockquote><p>This worked! On Mia’s and kira’s devices, anyway. It lagged on my device, so I experimented with optimization mods for local testing, eventually settling on VulkanMod for rendering. With this client-side optimization, the animation didn’t fall behind in the long run, though it remained somewhat laggy.<h2>Just a little bit more</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Goal</span></span>There were still some things I wanted to improve, like bit depth (i.e. the number of colors) and the count of optimized <eq><math><mrow><mn>2</mn><mo>×</mo></mrow><mrow><mn>2</mn></mrow></math></eq> blocks. Both of these issues hinged on getting access to significantly more than the <eq><math><mn>600</mn></math></eq> built-in blocks.<p>I’ve looked high and low for ways to add custom blocks, but all I found were tricks based on wrapping existing blocks in notoriously laggy item frames. And then…<p class=next-group><span aria-level=3 class=side-header role=heading><span>Blockstates</span></span>I looked at Minecraft’s packed assets again and found this in <code>assets/minecraft/blockstates/oak_log.json</code>:<pre><code class=language-json><span class=hljs-punctuation>{</span>
  <span class=hljs-attr>"variants"</span><span class=hljs-punctuation>:</span> <span class=hljs-punctuation>{</span>
    <span class=hljs-attr>"axis=x"</span><span class=hljs-punctuation>:</span> <span class=hljs-punctuation>{</span>
      <span class=hljs-attr>"model"</span><span class=hljs-punctuation>:</span> <span class=hljs-string>"minecraft:block/oak_log_horizontal"</span><span class=hljs-punctuation>,</span>
      <span class=hljs-attr>"x"</span><span class=hljs-punctuation>:</span> <span class=hljs-number>90</span><span class=hljs-punctuation>,</span>
      <span class=hljs-attr>"y"</span><span class=hljs-punctuation>:</span> <span class=hljs-number>90</span>
    <span class=hljs-punctuation>}</span><span class=hljs-punctuation>,</span>
    <span class=hljs-attr>"axis=y"</span><span class=hljs-punctuation>:</span> <span class=hljs-punctuation>{</span>
      <span class=hljs-attr>"model"</span><span class=hljs-punctuation>:</span> <span class=hljs-string>"minecraft:block/oak_log"</span>
    <span class=hljs-punctuation>}</span><span class=hljs-punctuation>,</span>
    <span class=hljs-attr>"axis=z"</span><span class=hljs-punctuation>:</span> <span class=hljs-punctuation>{</span>
      <span class=hljs-attr>"model"</span><span class=hljs-punctuation>:</span> <span class=hljs-string>"minecraft:block/oak_log_horizontal"</span><span class=hljs-punctuation>,</span>
      <span class=hljs-attr>"x"</span><span class=hljs-punctuation>:</span> <span class=hljs-number>90</span>
    <span class=hljs-punctuation>}</span>
  <span class=hljs-punctuation>}</span>
<span class=hljs-punctuation>}</span>
</code></pre><p>It’s possible to choose different models for a single block depending on its properties. Some blocks, like <code>grindstone</code>, have more complicated blockstate information, indicating that it’s possible to use combinations of properties as keys:<pre><code class=language-json><span class=hljs-punctuation>{</span>
  <span class=hljs-attr>"variants"</span><span class=hljs-punctuation>:</span> <span class=hljs-punctuation>{</span>
    <span class=hljs-attr>"face=ceiling,facing=east"</span><span class=hljs-punctuation>:</span> <span class=hljs-punctuation>{</span>
      <span class=hljs-attr>"model"</span><span class=hljs-punctuation>:</span> <span class=hljs-string>"minecraft:block/grindstone"</span><span class=hljs-punctuation>,</span>
      <span class=hljs-attr>"x"</span><span class=hljs-punctuation>:</span> <span class=hljs-number>180</span><span class=hljs-punctuation>,</span>
      <span class=hljs-attr>"y"</span><span class=hljs-punctuation>:</span> <span class=hljs-number>270</span>
    <span class=hljs-punctuation>}</span><span class=hljs-punctuation>,</span>
    <span class=hljs-attr>"face=ceiling,facing=north"</span><span class=hljs-punctuation>:</span> <span class=hljs-punctuation>{</span>
      <span class=hljs-attr>"model"</span><span class=hljs-punctuation>:</span> <span class=hljs-string>"minecraft:block/grindstone"</span><span class=hljs-punctuation>,</span>
      <span class=hljs-attr>"x"</span><span class=hljs-punctuation>:</span> <span class=hljs-number>180</span><span class=hljs-punctuation>,</span>
      <span class=hljs-attr>"y"</span><span class=hljs-punctuation>:</span> <span class=hljs-number>180</span>
    <span class=hljs-punctuation>}</span><span class=hljs-punctuation>,</span>
    ...
  <span class=hljs-punctuation>}</span>
<span class=hljs-punctuation>}</span>
</code></pre><p>With a quick script to extract variants from default assets, I could enumerate all blockstates, rather than just blocks.<pre><code class=language-bash><span class=hljs-keyword>for</span> name <span class=hljs-keyword>in</span> *; <span class=hljs-keyword>do</span> <span class=hljs-built_in>echo</span> -n <span class=hljs-variable>$name</span>; jq -c <span class=hljs-string>'. as $dot | try [[$dot.variants | keys[] | split(",") | [.[] | split("=") as [$key, $value] | {$key: $value}]] | transpose[] | unique | {"key": first | to_entries | .[].key, "value": [.[] | to_entries | .[0].value]}] catch [[$dot.multipart[].when] | del(.[] | nulls) as $data | $data? | [.[] | keys | .[0]] | unique | .[] | . as $key | {$key, "value": [$data | .[][$key]] | del(.[] | nulls)}] | from_entries'</span> <<span class=hljs-variable>$name</span>; <span class=hljs-keyword>done</span>
</code></pre><p>After filtering out unusable blockstates (e.g. the <code>shape</code> property of stairs is always recomputed automatically, so I couldn’t control it), this increased the count of accessible models from <eq><math><mn>600</mn></math></eq> to about <eq><math><mn>1700</mn></math></eq>. This enabled me to increase the number of colors to 6 and the number of optimized blocks to <eq><math><mn>400</mn></math></eq>.<h2>Mechanics</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Audio</span></span>With video playback out of the way, it was time to turn to other matters. One feature addition I thought would be nice was music.<p>Resource packs can change the music played by discs. The duration of the music disc stays fixed even if the audio is replaced, so I used <em>Relic</em> as the music disc since it has the closest duration to “Bad Apple!!”. Just for fun, I replaced the name of the disc with a language file (<code>assets/minecraft/lang/en_us.json</code>), so that the in-game subtitles say “Now Playing: Bad Apple!!” when the disc is played:<pre><code class=language-json><span class=hljs-punctuation>{</span>
    <span class=hljs-attr>"jukebox_song.minecraft.relic"</span><span class=hljs-punctuation>:</span> <span class=hljs-string>"Bad Apple!!"</span>
<span class=hljs-punctuation>}</span>
</code></pre><p>To control when the music is played, I hooked up a jukebox to a dropper controlled by a button:<p><div class=diagram><img alt="A 2x2 device, oriented vertically. The top right block is a jukebox. The bottom left block is a dropper pointing upwards. They are connected in a loop by two hoppers, one in each corner: the top-left hopper points to the right, the bottom-right hopper points to the left. An oak button powers the dropper through redstone dust."title="A 2x2 device, oriented vertically. The top right block is a jukebox. The bottom left block is a dropper pointing upwards. They are connected in a loop by two hoppers, one in each corner: the top-left hopper points to the right, the bottom-right hopper points to the left. An oak button powers the dropper through redstone dust."src=jukebox.png></div><p>The dropper contains one music disc. When the button is pressed, the dropper is activated and transfers the disc to the hopper. The hopper then moves the disc to the jukebox, starting playback. When the jukebox stops playing the disc, the hoppers unlock, and the disc is transferred to the dropper by the bottom-right hopper, ready to be inserted again.<p>There were some troubles with quasiconnectivity: the jukebox emits a redstone signal while playing music, so the hoppers are powered, which in turn powers the dropper by QC. When the music ends, the dropper is not updated and remains powered, so the next button press doesn’t start the music again.<p>The workaround is as follows:<p><div class=diagram><img alt="The same mechanism, powered differently. The dropper is powered by a repeater, directly connected to redstone dust on the receiving end, directly connected to a button."title="The same mechanism, powered differently. The dropper is powered by a repeater, directly connected to redstone dust on the receiving end, directly connected to a button."src=jukebox-qc-workaround.png></div><p>When the button is pressed, the dust is powered, which in turn updates the dropper by QC (because the taxicab distance between the components is <eq><math><mn>2</mn></math></eq>). The dropper realizes it should reset and switches off. One redstone tick later, the repeater powers the dropper again, and the disc is inserted.<p>Any other method of delaying the signal works too, not just with repeaters.<p class=next-group><span aria-level=3 class=side-header role=heading><span>3… 2… 1…</span></span>For some final UX improvements, it’d’ve been pretty good if the demo could be started without, you know, needing to press 25 buttons under <code>/tick freeze</code>.<p>For the viewer to see the whole screen at once, they had to be positioned far enough away. I didn’t want the wiring to be visible, and replacing the models for redstone dust and repeaters with empty ones felt like bad taste. In addition, this would inevitably introduce significant delays, which I wanted to avoid, and hiding instant wire sounded like overengineering, if it even was doable.<p>What I really wanted was essentially wireless redstone. Sculk sensors wouldn’t work at such a long distance, so I had to find another solution. I was about to use <a href=https://www.reddit.com/r/technicalminecraft/comments/n5wshk/new_highspeed_wireless_redstone_device_based_on/>2No2Name’s system</a>…<p>…but then I remembered something I stumbled upon while figuring out how to draw animation with structure blocks. I encountered a bug where triggering a recursive structure block attempted to perform all the recursive loads in a single tick. What if I used that feature benevolently?<p>Yuki helped me devise a way to create instant wire using structure blocks. It’s not a perfect wire since it only transfers pulses, but it works for my use case:<p><div class=diagram><img alt="Three components, spaced far enough apart that redstone signal can't travel between them. The first component is a button powering a structure block in LOAD mode. The second component is a disabled redstone torch sitting atop a redstone block, connected via redstone dust to another structure block in LOAD mode. The third component is a disabled redstone torch sitting atop a redstone block, connected via redstone dust to a redstone lamp."title="Three components, spaced far enough apart that redstone signal can't travel between them. The first component is a button powering a structure block in LOAD mode. The second component is a disabled redstone torch sitting atop a redstone block, connected via redstone dust to another structure block in LOAD mode. The third component is a disabled redstone torch sitting atop a redstone block, connected via redstone dust to a redstone lamp."src=instant-wire.png></div><p>Whenever the button is pressed, the structure block loads a <em>powered</em> redstone torch over the unpowered torch in the middle component. This torch gets unpowered on the next tick because it’s sitting on a redstone block, but before that happens, it activates another structure block. This structure block spawns a powered redstone torch in the third component, triggering the lamp.<p><div class=diagram><strong class=epilepsy> This video contains flashes that might trigger seizures in people with photosensitive epilepsy. Stop watching if you experience any symptoms. For convenience, the title text for the video explains the action in prose. </strong><video alt="The same three components, showing that the lamp is activated with zero delay when the button is pressed."title="The same three components, showing that the lamp is activated with zero delay when the button is pressed."controls loop muted playsinline preload=auto src=instant-wire.webm#epilepsy></video></div><p>A structure block spans up to <eq><math><mn>48</mn></math></eq> blocks, so this method helped me transfer startup signals across a grid of <eq><math><mrow><mn>48</mn><mo>×</mo></mrow><mrow><mn>48</mn></mrow></math></eq> subscreens.<p class=next-group><span aria-level=3 class=side-header role=heading><span>0… -1… -2…</span></span>It, however, didn’t help transfer the signal from the viewer to behind the screen, as that distance was about <eq><math><mn>150</mn></math></eq> blocks. Using torches was convenient because they didn’t need to be manually reset – each torch was disabled by the redstone block in the next tick, ready for the next pulse. In this case, though, I had to add reset facilities to the mechanism myself.<p>The idea was simple. When a button is activated, a structure block should spawn another structure block sitting atop a redstone block. That structure block will activate immediately and should replace itself and the redstone block with air, while also spawning another structure block + redstone block construct further along the line. This repeats until the signal reaches the receiver.<p>In practice, this can’t be built in creative because placing a structure block and a redstone block next to each other activates the structure block immediately, without enough time to save the construct in the deactivated state. (I did manage to work around this once, but I can’t reproduce it.) Luckily, I had a Python library to generate structure files from <a href=https://en.wikipedia.org/wiki/Greenspun's_tenth_rule>LISPy code</a>, so getting the instant wire working was as simple as writing it out by hand in a straightforward format:<pre><code class=language-python><span class=hljs-comment># ...</span>
structure(
    <span class=hljs-string>"starter2"</span>,
    (<span class=hljs-number>22</span>, <span class=hljs-number>2</span>, <span class=hljs-number>48</span>),
    air((<span class=hljs-number>0</span>, <span class=hljs-number>0</span>, <span class=hljs-number>47</span>)),
    air((<span class=hljs-number>0</span>, <span class=hljs-number>1</span>, <span class=hljs-number>47</span>)),
    redstone_block((<span class=hljs-number>21</span>, <span class=hljs-number>0</span>, <span class=hljs-number>0</span>)),
    structure_block((<span class=hljs-number>21</span>, <span class=hljs-number>1</span>, <span class=hljs-number>0</span>), offset=(<span class=hljs-number>0</span>, -<span class=hljs-number>1</span>, -<span class=hljs-number>47</span>), size=(<span class=hljs-number>1</span>, <span class=hljs-number>2</span>, <span class=hljs-number>48</span>), name=<span class=hljs-string>"starter3"</span>)
)
<span class=hljs-comment># ...</span>
</code></pre><p class=next-group><span aria-level=3 class=side-header role=heading><span>Box</span></span>With all the mechanisms ready, I combined them in a small <eq><math><mrow><mn>4</mn><mo>×</mo></mrow><mrow><mn>2</mn><mo>×</mo></mrow><mrow><mn>3</mn></mrow></math></eq> box, activated by an outside button:<p><div class=diagram><img alt="Two separate instant wire activators: one triggered by a repeater and another by a redstone block at the head of a sticky piston. When extended, the redstone block also powers the automatic jukebox mechanism."title="Two separate instant wire activators: one triggered by a repeater and another by a redstone block at the head of a sticky piston. When extended, the redstone block also powers the automatic jukebox mechanism."src=starter.png></div><h2>Preparing frames</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Setup</span></span>Now that the playback system was set up and ready, I could spend some time polishing the video material itself. It seemed like a strange task, given that the hardest, most interesting part was already behind me, but it made for a nice change of pace.<p>There were two main issues to solve:<ul><li>How do I translate a full-color video to 6 colors, producing the highest quality picture?<li>How do I translate a 30 fps video to 20 fps?</ul><p class=next-group><span aria-level=3 class=side-header role=heading><span>Colors</span></span>Some people believe “Bad Apple!!” is purely black-and-white, but there are <em>many</em> contexts in which it uses full-color grayscale.<p>Motion blur:<p><div class=diagram><img alt="A girl raising a hand with an apple at large velocity, with the apple and the hand blurred significantly."title="A girl raising a hand with an apple at large velocity, with the apple and the hand blurred significantly."src=grayscale-apple-original.png></div><p>Glow and objects of different brightness:<p><div class=diagram><img alt="A girl flying on a broom towards a castle under a night sky."title="A girl flying on a broom towards a castle under a night sky."src=grayscale-sky-original.png></div><p>Gradients between scenes:<p><div class=diagram><img alt="A transition from a black-background scene to a white-background scene with a gradient."title="A transition from a black-background scene to a white-background scene with a gradient."src=grayscale-gradient-original.png></div><p>In high-speed scenes, the motion blur is enchanced by overlapping 5 frames of an <eq><math><mrow><mo>≈</mo></mrow><mrow><mn>200</mn></mrow></math></eq> fps video with different opacity, leaving a trace:<p><div class=diagram><img alt="A girl spinning, with arms leaving a trace."title="A girl spinning, with arms leaving a trace."src=grayscale-trace-original.png></div><p>Blur (the girl in the background) and gradients:<p><div class=diagram><img alt="A girl swiping a sword, with the sword leaving a gradient trace. Another girl in the background is blurred, as if out of focus."title="A girl swiping a sword, with the sword leaving a gradient trace. Another girl in the background is blurred, as if out of focus."src=grayscale-blur-gradient-original.png></div><p>Fire:<p><div class=diagram><img alt="A girl with fire emanating from her hands."title="A girl with fire emanating from her hands."src=grayscale-fire-original.png></div><p>The sun:<p><div class=diagram><img alt="A girl and the sun, with a radial gradient around the sun."title="A girl and the sun, with a radial gradient around the sun."src=grayscale-sun-original.png></div><p>Shadows:<p><div class=diagram><img alt="Three girls playing instruments, with shadows."title="Three girls playing instruments, with shadows."src=grayscale-shadows-original.png></div><p>Ripples in water:<p><div class=diagram><img alt="Ripples spreading from a falling drop."title="Ripples spreading from a falling drop."src=grayscale-water-original.png></div><p>Simply rounding to the nearest representable color doesn’t do these frames justice, introducing <a href=https://en.wikipedia.org/wiki/Colour_banding>banding</a>:<p><div class=diagram><img alt="A girl swiping a sword, with the sword leaving a gradient trace. The gradient is heavily banded."title="A girl swiping a sword, with the sword leaving a gradient trace. The gradient is heavily banded."src=grayscale-blur-gradient-nn.png></div><p><div class=diagram><img alt="A girl and the sun, with a radial gradient around the sun. The gradient is heavily banded."title="A girl and the sun, with a radial gradient around the sun. The gradient is heavily banded."src=grayscale-sun-nn.png></div><p>This is typically solved by dithering, a technique where an area of pixels of non-exactly representable colors is translated into a pattern of interleaved close representable colors:<p><div class=diagram><img alt="A girl swiping a sword, with the sword leaving a gradient trace. The gradient is of average quality, but not chunky anymore."title="A girl swiping a sword, with the sword leaving a gradient trace. The gradient is of average quality, but not chunky anymore."src=grayscale-blur-gradient-bluenoise.png></div><p><div class=diagram><img alt="A girl and the sun, with a radial gradient around the sun. The gradient is of average quality, but not chunky anymore."title="A girl and the sun, with a radial gradient around the sun. The gradient is of average quality, but not chunky anymore."src=grayscale-sun-bluenoise.png></div><p>There’s just one problem. High-quality dither algorithms are complex beasts, and the results they produce, though great, depend heavily on the original image. For animation, this means that two consecutive frames, while “close” to a human eye, may produce radically different dithered outputs. This is troublesome for two reasons:<ul><li>A human eye can easily notice this inconsistency.<li>This leads to many updates, especially in fast-paced scenes, more than Minecraft can reasonably handle.</ul><p>Luckily, “local” dither algorithms exist, like <a href=https://en.wikipedia.org/wiki/Ordered_dithering>Bayer dithering</a>:<p><div class=diagram><img alt="A girl and the sun, with a radial gradient around the sun. The gradient is of average quality, but not chunky anymore."title="A girl and the sun, with a radial gradient around the sun. The gradient is of average quality, but not chunky anymore."src=grayscale-sun-bayer.png></div><p>However, subjectively, their results are of worse quality than “global” algorithms, failing to completely remove banding. Fortunately, there’s a middle ground <a href=https://en.wikipedia.org/wiki/Ordered_dithering#Void_and_cluster>solution</a> based on blue noise. In short, a certain kind of grayscale noise is added to the frames pixelwise, and the pixels are then rounded to the nearest representable colors. The two non-Bayerian pictures above demonstrate this method using GIMP.<p>Unfortunately, <code>ffmpeg</code>, the tool I used to generate video, doesn’t support blue noise dithering, so I had to take a texture from <a href=https://momentsingraphics.de/BlueNoise.html>Christoph Peters’s blog</a>, crop it to <eq><math><mrow><mn>512</mn><mo>×</mo></mrow><mrow><mn>384</mn></mrow></math></eq>, and apply dithering manually with a script in Rust. (I didn’t want to wait half an hour for Python to finish, only to discover an off-by-one error.) The result was a bit worse than the examples above, as I had to choose one palette for all frames, but it was still good enough:<p><div class=diagram><img alt="A girl swiping a sword, with the sword leaving a gradient trace. The gradient is of average quality, but not chunky anymore."title="A girl swiping a sword, with the sword leaving a gradient trace. The gradient is of average quality, but not chunky anymore."src=grayscale-blur-gradient-final.png></div><p><div class=diagram><img alt="A girl and the sun, with a radial gradient around the sun. The gradient is of average quality, but not chunky anymore."title="A girl and the sun, with a radial gradient around the sun. The gradient is of average quality, but not chunky anymore."src=grayscale-sun-final.png></div><p class=next-group><span aria-level=3 class=side-header role=heading><span>Oopsie</span></span>One problem becomes apparent when dithering is implemented, however.<p>Where did these dark gray pixels come from?<p><div class=diagram><img alt="A girl holding an apple. The girl's is not perfectly black, there are some gray pixels."title="A girl holding an apple. The girl's is not perfectly black, there are some gray pixels."src=grayscale-hand-fullrange.png></div><p>The stars shouldn’t be this noisy and large:<p><div class=diagram><img alt="A girl flying on a broom towards a castle under a night sky. The stars are visibly noisy."title="A girl flying on a broom towards a castle under a night sky. The stars are visibly noisy."src=grayscale-sky-fullrange.png></div><p>What’s this uneven gradient?<p><div class=diagram><img alt="A girl and the sun, with a radial gradient around the sun. The gradient starts as an ideal circle but is malformed at the edge."title="A girl and the sun, with a radial gradient around the sun. The gradient starts as an ideal circle but is malformed at the edge."src=grayscale-sun-fullrange.png></div><p>You see, the source of the Bad Apple!! animation is an <a href=https://www.nicovideo.jp/watch/sm8628149>upload</a> on <a href=https://en.wikipedia.org/wiki/Niconico>Niconico</a> by an anonymous user. I tried to reach them via various channels to no avail, so I only had access to lossily compressed material. These artifacts are present in the original video too, they are just less visible.<p>Is it even possible to denoise a video while neither blurring edges nor introducing gradient banding? Sort of. Bad Apple!! has few solid gray regions, so visible noise mostly occurs on blacks and whites only. This meant that I could simply round almost-blacks to black, almost-whites to white, and spread the inbetween colors for continuity:<p><div class=diagram><img alt="A Curves graph from GIMP. Values 0-15 are mapped to 0, values 16-239 are mapped to 0-255 linearly, values 240-255 are mapped to 255."title="A Curves graph from GIMP. Values 0-15 are mapped to 0, values 16-239 are mapped to 0-255 linearly, values 240-255 are mapped to 255."src=curves.png></div><p>That’s better.<p><div class=diagram><img alt="A girl holding an apple. The girl's is almost perfectly black."title="A girl holding an apple. The girl's is almost perfectly black."src=grayscale-hand-reducedrange.png></div><p><div class=diagram><img alt="A girl flying on a broom towards a castle under a night sky. The stars are not noisy."title="A girl flying on a broom towards a castle under a night sky. The stars are not noisy."src=grayscale-sky-reducedrange.png></div><p><div class=diagram><img alt="A girl and the sun, with a radial gradient around the sun. The gradient is a lot smaller than before, but is almost perfectly circular."title="A girl and the sun, with a radial gradient around the sun. The gradient is a lot smaller than before, but is almost perfectly circular."src=grayscale-sun-reducedrange.png></div><p class=next-group><span aria-level=3 class=side-header role=heading><span>Frame rate</span></span>Transforming 30 fps to 20 fps sounds like a no-brainer. Just drop every third frame. But there’s a reason we don’t just drop every third pixel while resizing an image, and the same principle applies to the time axis.<p>Suppose there’s an object moving with constant velocity across several frames. Before downsampling, the object travels the same distance between consecutive frames. After downsampling, the object travels twice as much in odd frames as in even ones.<p>This is jarring to the human eye! In addition, this means that odd frames usually contain twice as many updates as even frames, resulting in a saw-like pattern in the MSPT (milliseconds per tick) plot.<p>Unfortunately, we couldn’t find a better solution. While there are many 60 fps videos of “Bad Apple!!” online, these videos were upscaled using AI or other automatic tools. Neither stood a chance against fast-paced scene changes, producing tons of artifacts.<h2>So long, and thanks for all the fish</h2><p class=next-group><span aria-level=3 class=side-header role=heading><span>Retrospective</span></span>And… that’s it? Looking back, the result looks almost trivial to achieve, which raises the question of why no one has done it before.<p>It was certainly a winding path, with many dead ends I didn’t mention. I started with a <eq><math><mrow><mn>48</mn><mo>×</mo></mrow><mrow><mn>36</mn></mrow></math></eq> screen and 2 colors, reached <eq><math><mrow><mn>128</mn><mo>×</mo></mrow><mrow><mn>96</mn></mrow></math></eq> and 10 colors, then increased the resolution to <eq><math><mrow><mn>256</mn><mo>×</mo></mrow><mrow><mn>192</mn></mrow></math></eq>, and finally reduced the number of colors to 6 to achieve <eq><math><mrow><mn>512</mn><mo>×</mo></mrow><mrow><mn>384</mn></mrow></math></eq>. I even attempted to play the music with note blocks, only to realize that achieving good quality might as well be a whole 'nother project. I invented structstone and began prototyping a full-blown computer using this technique.<p>I played around with <code>ffmpeg</code>, switched to <code>mpv</code> as my go-to media player, and finally got around to trying out <a href=https://lib.rs/image>the image crate</a>. I wrote code during SSRI-induced sleepless nights. I treated this project like a hackaton, sacrificing code quality for development speed, only to realize I didn’t fully account for <a href=https://en.wikipedia.org/wiki/Pareto_principle>the Pareto principle</a>. I read Minecraft’s decompiled code and wrote <a href=../ru/minecraft-compares-arrays-in-cubic-time/>a post</a> about what I found. I even used various tricks to minimize the world’s directory size.<p>This was a fun experience. Even though it took more than a month, and I grew tired and a bit resentful, I enjoyed thinking outside the box and collaborating with friends. It was a refreshing change of pace compared to my usual projects. Honestly, I think every developer should try to build something like this for a while. Who knows what you might invent?</div></section><footer><div class=viewport-container><h2>Made with my own bare hands (why.)</h2></div></footer><script>window.addEventListener("keydown", e => {
				if (e.key === "Enter") {
					if (e.ctrlKey) {
						window.open("https://github.com/purplesyringa/site/edit/master/blog/we-built-the-best-bad-apple-in-minecraft/index.md", "_blank");
					} else if (
						e.target.type === "checkbox"
						&& e.target.parentNode
						&& e.target.parentNode.className === "expansible-code"
					) {
						e.target.click();
					}
				}
			});</script>